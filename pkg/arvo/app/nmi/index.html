<!doctype html>
<html>
  <head>
    <title>Step 1</title>
  </head>
  <body>
    <h1>Planet Market</h1>
    <div id="step1" style="display:none;">
      <button id="step1-button">Buy a Planet</button>
    </div>
    <div id="step2" style="display:none;">
      <h2>Enter Card Details</h2>
      <form id="step2-form" method="POST" action="">
        <input name="billing-cc-number" type="text" value="4111111111111111" />
        <input name="billing-cc-exp" type="text" value="10/12" />
        <input name="cvv" type="text" value="999" />
        <input type ="submit" value="Submit" />
      </form>
    </div>
    <div id="step3" style="display:none;">
      <h2 id="step3-status"></h1>
    </div>
    <script type="text/javascript">
      let startPayment = async () => {
        let data = `{
          "initiate-payment": "20.00"
        }`;

        const res = await fetch(`/pay`, {
          method: 'POST',
          headers: { 'Content-type': 'text/json' },
          body: data
        });

        return res.json();
      };

      let pollForStepOneResponse = (file, stepTwo = () => {}) => {
        setTimeout(() => {
          fetch(`/pay/${file}.json`, {
            method: 'GET',
            mode: 'cors',
            headers: {
              'Content-type': 'text/json',
              'Access-Control-Allow-Origin':'*'
            },
            body: null
          }).then((res) => {
            if (res.ok) {
              return res.json();
            } else {
              throw new Error('Something went wrong');
            }
          }).then((result) => {
            stepTwo(result);
          }).catch((error) => {
            console.error('Error:', error);
            pollForStepOneResponse(file, stepTwo);
          });
        }, 500);
      };

      let stepTwo = (tokenId) => {
        let stepOne = document.getElementById('step1');
        stepOne.style = 'display:none;';

        let stepTwo = document.getElementById('step2');
        stepTwo.style = 'display:block;'

        let form = document.getElementById('step2-form');
        form.action =
          `https://secure.networkmerchants.com/api/v2/three-step/${tokenId}`;
      };

      let stepThree = (tokenId) => {
        let data = `{
          "complete-payment": "${tokenId}"
        }`;

        fetch(`/pay`, {
          method: 'POST',
          headers: { 'Content-type': 'text/json' },
          body: data
        }).then((res) => {
          if (res.ok) {
            return res.json();
          } else {
            throw new Error('Something went wrong');
          }
        }).then(res => {
          let status = document.getElementById('step3-status');
          status.innerText = "Payment Successful!"
        })
        .catch((error) => {
          window.location.replace("http://urbit.studio/pay");
        });
      };

      let params = (new URL(document.location)).searchParams;
      let tokenId = params.get('token-id');
      if (!!tokenId && tokenId.length > 0) {
        let thirdStep = document.getElementById('step3');
        thirdStep.style = "display:block;";
        stepThree(tokenId);

      } else {
        let firstStep = document.getElementById('step1');
        firstStep.style = "display:block;";

        let button = document.getElementById('step1-button');
        button.onclick = async () => {
          let firstResponse = await startPayment();
          pollForStepOneResponse(firstResponse, stepTwo);
        };

      }
    </script>
  </body>
</html>
